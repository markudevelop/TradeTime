<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Market Status</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/luxon/3.4.4/luxon.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        .card:hover {
            transform: scale(1.01);
            transition: transform 0.2s ease-in-out;
        }
        .status-open {
            background-color: #10B981;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            display: inline-block;
        }
        .status-closed {
            background-color: #EF4444;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            display: inline-block;
        }
        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .collapsible-content.active {
            max-height: 300px;
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col items-center justify-center p-4 sm:p-6">
    <div class="max-w-lg w-full">
        <h1 class="text-3xl font-bold text-center text-indigo-400 mb-6">Market Status</h1>
        <p class="text-center text-gray-300 mb-6 text-base">Check if the US stock market is open or closed, with times in Eastern Time (ET) and your local timezone. Select a broker and timezone below.</p>
      
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
            <div>
                <label for="broker-select" class="block text-sm font-medium text-gray-200 mb-2">Broker</label>
                <select id="broker-select" onchange="updateBroker()" class="w-full p-3 rounded-lg bg-gray-800 text-white border border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-400 transition duration-200">
                    <option value="standard">Standard (4:00 AM ET)</option>
                    <option value="tastytrade">tastytrade (8:00 AM ET)</option>
                    <option value="interactive_brokers">Interactive Brokers (4:00 AM ET)</option>
                    <option value="webull">Webull (4:00 AM ET)</option>
                    <option value="moomoo">Moomoo (4:00 AM ET)</option>
                    <option value="tradestation">TradeStation (4:00 AM ET)</option>
                    <option value="alpaca">Alpaca Trading (4:00 AM ET)</option>
                    <option value="lightspeed">Lightspeed (4:00 AM ET)</option>
                    <option value="tradezero">TradeZero (4:00 AM ET)</option>
                </select>
            </div>
            <div>
                <label for="country-select" class="block text-sm font-medium text-gray-200 mb-2">Timezone</label>
                <select id="country-select" onchange="updateCountry()" class="w-full p-3 rounded-lg bg-gray-800 text-white border border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-400 transition duration-200">
                    <option value="auto|auto">Auto Detected</option>
                    <option value="Afghanistan|Asia/Kabul">Afghanistan (+04:30)</option>
                    <option value="Albania|Europe/Tirane">Albania (CET/CEST)</option>
                    <option value="Algeria|Africa/Algiers">Algeria (CET)</option>
                    <option value="Andorra|Europe/Andorra">Andorra (CET/CEST)</option>
                    <option value="Angola|Africa/Luanda">Angola (WAT)</option>
                    <option value="Argentina|America/Argentina/Buenos_Aires">Argentina (ART)</option>
                    <option value="Armenia|Asia/Yerevan">Armenia (+04)</option>
                    <option value="Australia|Australia/Sydney">Australia/Sydney (AEST/AEDT)</option>
                    <option value="Australia|Australia/Brisbane">Australia/Brisbane (AEST)</option>
                    <option value="Australia|Australia/Perth">Australia/Perth (AWST)</option>
                    <option value="Austria|Europe/Vienna">Austria (CET/CEST)</option>
                    <option value="Azerbaijan|Asia/Baku">Azerbaijan (+04)</option>
                    <option value="Bahamas|America/Nassau">Bahamas (EST/EDT)</option>
                    <option value="Bahrain|Asia/Bahrain">Bahrain (+03)</option>
                    <option value="Bangladesh|Asia/Dhaka">Bangladesh (+06)</option>
                    <option value="Barbados|America/Barbados">Barbados (AST)</option>
                    <option value="Belarus|Europe/Minsk">Belarus (+03)</option>
                    <option value="Belgium|Europe/Brussels">Belgium (CET/CEST)</option>
                    <option value="Belize|America/Belize">Belize (CST)</option>
                    <option value="Benin|Africa/Porto-Novo">Benin (WAT)</option>
                    <option value="Bhutan|Asia/Thimphu">Bhutan (+06)</option>
                    <option value="Bolivia|America/La_Paz">Bolivia (BOT)</option>
                    <option value="Bosnia and Herzegovina|Europe/Sarajevo">Bosnia and Herzegovina (CET/CEST)</option>
                    <option value="Botswana|Africa/Gaborone">Botswana (CAT)</option>
                    <option value="Brazil|America/Sao_Paulo">Brazil (BRT/BRST)</option>
                    <option value="Brunei|Asia/Brunei">Brunei (+08)</option>
                    <option value="Bulgaria|Europe/Sofia">Bulgaria (EET/EEST)</option>
                    <option value="Burkina Faso|Africa/Ouagadougou">Burkina Faso (GMT)</option>
                    <option value="Burundi|Africa/Bujumbura">Burundi (CAT)</option>
                    <option value="Cambodia|Asia/Phnom_Penh">Cambodia (+07)</option>
                    <option value="Cameroon|Africa/Douala">Cameroon (WAT)</option>
                    <option value="Canada|America/Toronto">Canada/Toronto (EST/EDT)</option>
                    <option value="Canada|America/Vancouver">Canada/Vancouver (PST/PDT)</option>
                    <option value="Canada|America/Winnipeg">Canada/Winnipeg (CST/CDT)</option>
                    <option value="Cape Verde|Atlantic/Cape_Verde">Cape Verde (-01)</option>
                    <option value="Chad|Africa/Ndjamena">Chad (WAT)</option>
                    <option value="Chile|America/Santiago">Chile (CLT/CLST)</option>
                    <option value="China|Asia/Shanghai">China (CST)</option>
                    <option value="Colombia|America/Bogota">Colombia (COT)</option>
                    <option value="Comoros|Indian/Comoro">Comoros (EAT)</option>
                    <option value="Congo (DRC)|Africa/Kinshasa">Congo (DRC) (WAT)</option>
                    <option value="Congo|Africa/Brazzaville">Congo (WAT)</option>
                    <option value="Costa Rica|America/Costa_Rica">Costa Rica (CST)</option>
                    <option value="Côte d'Ivoire|Africa/Abidjan">Côte d'Ivoire (GMT)</option>
                    <option value="Croatia|Europe/Zagreb">Croatia (CET/CEST)</option>
                    <option value="Cuba|America/Havana">Cuba (CST/CDT)</option>
                    <option value="Cyprus|Asia/Nicosia">Cyprus (EET/EEST)</option>
                    <option value="Czech Republic|Europe/Prague">Czech Republic (CET/CEST)</option>
                    <option value="Denmark|Europe/Copenhagen">Denmark (CET/CEST)</option>
                    <option value="Djibouti|Africa/Djibouti">Djibouti (EAT)</option>
                    <option value="Dominica|America/Dominica">Dominica (AST)</option>
                    <option value="Dominican Republic|America/Santo_Domingo">Dominican Republic (AST)</option>
                    <option value="Ecuador|America/Guayaquil">Ecuador (-05)</option>
                    <option value="Egypt|Africa/Cairo">Egypt (EET)</option>
                    <option value="El Salvador|America/El_Salvador">El Salvador (CST)</option>
                    <option value="Equatorial Guinea|Africa/Malabo">Equatorial Guinea (WAT)</option>
                    <option value="Eritrea|Africa/Asmara">Eritrea (EAT)</option>
                    <option value="Estonia|Europe/Tallinn">Estonia (EET/EEST)</option>
                    <option value="Eswatini|Africa/Mbabane">Eswatini (SAST)</option>
                    <option value="Ethiopia|Africa/Addis_Ababa">Ethiopia (EAT)</option>
                    <option value="Fiji|Pacific/Fiji">Fiji (+12)</option>
                    <option value="Finland|Europe/Helsinki">Finland (EET/EEST)</option>
                    <option value="France|Europe/Paris">France (CET/CEST)</option>
                    <option value="Gabon|Africa/Libreville">Gabon (WAT)</option>
                    <option value="Gambia|Africa/Banjul">Gambia (GMT)</option>
                    <option value="Georgia|Asia/Tbilisi">Georgia (+04)</option>
                    <option value="Germany|Europe/Berlin">Germany (CET/CEST)</option>
                    <option value="Ghana|Africa/Accra">Ghana (GMT)</option>
                    <option value="Greece|Europe/Athens">Greece (EET/EEST)</option>
                    <option value="Grenada|America/Grenada">Grenada (AST)</option>
                    <option value="Guatemala|America/Guatemala">Guatemala (CST)</option>
                    <option value="Guinea|Africa/Conakry">Guinea (GMT)</option>
                    <option value="Guinea-Bissau|Africa/Bissau">Guinea-Bissau (GMT)</option>
                    <option value="Guyana|America/Guyana">Guyana (-04)</option>
                    <option value="Haiti|America/Port-au-Prince">Haiti (EST/EDT)</option>
                    <option value="Honduras|America/Tegucigalpa">Honduras (CST)</option>
                    <option value="Hong Kong|Asia/Hong_Kong">Hong Kong (HKT)</option>
                    <option value="Hungary|Europe/Budapest">Hungary (CET/CEST)</option>
                    <option value="Iceland|Atlantic/Reykjavik">Iceland (GMT)</option>
                    <option value="India|Asia/Kolkata">India (IST)</option>
                    <option value="Indonesia|Asia/Jakarta">Indonesia/Jakarta (WIB/+07)</option>
                    <option value="Indonesia|Asia/Makassar">Indonesia/Makassar (WITA/+08)</option>
                    <option value="Indonesia|Asia/Jayapura">Indonesia/Jayapura (WIT/+09)</option>
                    <option value="Iran|Asia/Tehran">Iran (IRST)</option>
                    <option value="Iraq|Asia/Baghdad">Iraq (AST)</option>
                    <option value="Ireland|Europe/Dublin">Ireland (GMT/IST)</option>
                    <option value="Israel|Asia/Jerusalem">Israel (IST/IDT)</option>
                    <option value="Italy|Europe/Rome">Italy (CET/CEST)</option>
                    <option value="Jamaica|America/Jamaica">Jamaica (EST)</option>
                    <option value="Japan|Asia/Tokyo">Japan (JST)</option>
                    <option value="Jordan|Asia/Amman">Jordan (+03)</option>
                    <option value="Kazakhstan|Asia/Almaty">Kazakhstan (+06)</option>
                    <option value="Kenya|Africa/Nairobi">Kenya (EAT)</option>
                    <option value="Kiribati|Pacific/Tarawa">Kiribati (+12)</option>
                    <option value="Kuwait|Asia/Kuwait">Kuwait (+03)</option>
                    <option value="Kyrgyzstan|Asia/Bishkek">Kyrgyzstan (+06)</option>
                    <option value="Laos|Asia/Vientiane">Laos (+07)</option>
                    <option value="Latvia|Europe/Riga">Latvia (EET/EEST)</option>
                    <option value="Lebanon|Asia/Beirut">Lebanon (EET/EEST)</option>
                    <option value="Lesotho|Africa/Maseru">Lesotho (SAST)</option>
                    <option value="Liberia|Africa/Monrovia">Liberia (GMT)</option>
                    <option value="Libya|Africa/Tripoli">Libya (EET)</option>
                    <option value="Liechtenstein|Europe/Vaduz">Liechtenstein (CET/CEST)</option>
                    <option value="Lithuania|Europe/Vilnius">Lithuania (EET/EEST)</option>
                    <option value="Luxembourg|Europe/Luxembourg">Luxembourg (CET/CEST)</option>
                    <option value="Madagascar|Indian/Antananarivo">Madagascar (EAT)</option>
                    <option value="Malawi|Africa/Blantyre">Malawi (CAT)</option>
                    <option value="Malaysia|Asia/Kuala_Lumpur">Malaysia (MYT)</option>
                    <option value="Maldives|Indian/Maldives">Maldives (+05)</option>
                    <option value="Mali|Africa/Bamako">Mali (GMT)</option>
                    <option value="Malta|Europe/Malta">Malta (CET/CEST)</option>
                    <option value="Mauritania|Africa/Nouakchott">Mauritania (GMT)</option>
                    <option value="Mauritius|Indian/Mauritius">Mauritius (+04)</option>
                    <option value="Mexico|America/Mexico_City">Mexico (CST/CDT)</option>
                    <option value="Moldova|Europe/Chisinau">Moldova (EET/EEST)</option>
                    <option value="Monaco|Europe/Monaco">Monaco (CET/CEST)</option>
                    <option value="Mongolia|Asia/Ulaanbaatar">Mongolia (+08)</option>
                    <option value="Montenegro|Europe/Podgorica">Montenegro (CET/CEST)</option>
                    <option value="Morocco|Africa/Casablanca">Morocco (+01)</option>
                    <option value="Mozambique|Africa/Maputo">Mozambique (CAT)</option>
                    <option value="Myanmar|Asia/Yangon">Myanmar (+06:30)</option>
                    <option value="Namibia|Africa/Windhoek">Namibia (CAT)</option>
                    <option value="Nepal|Asia/Kathmandu">Nepal (+05:45)</option>
                    <option value="Netherlands|Europe/Amsterdam">Netherlands (CET/CEST)</option>
                    <option value="New Zealand|Pacific/Auckland">New Zealand (NZST/NZDT)</option>
                    <option value="Nicaragua|America/Managua">Nicaragua (CST)</option>
                    <option value="Niger|Africa/Niamey">Niger (WAT)</option>
                    <option value="Nigeria|Africa/Lagos">Nigeria (WAT)</option>
                    <option value="North Korea|Asia/Pyongyang">North Korea (KST)</option>
                    <option value="North Macedonia|Europe/Skopje">North Macedonia (CET/CEST)</option>
                    <option value="Norway|Europe/Oslo">Norway (CET/CEST)</option>
                    <option value="Oman|Asia/Muscat">Oman (+04)</option>
                    <option value="Pakistan|Asia/Karachi">Pakistan (PKT)</option>
                    <option value="Panama|America/Panama">Panama (EST)</option>
                    <option value="Papua New Guinea|Pacific/Port_Moresby">Papua New Guinea (+10)</option>
                    <option value="Paraguay|America/Asuncion">Paraguay (-04)</option>
                    <option value="Peru|America/Lima">Peru (PET)</option>
                    <option value="Philippines|Asia/Manila">Philippines (PST)</option>
                    <option value="Poland|Europe/Warsaw">Poland (CET/CEST)</option>
                    <option value="Portugal|Europe/Lisbon">Portugal (WET/WEST)</option>
                    <option value="Qatar|Asia/Qatar">Qatar (+03)</option>
                    <option value="Romania|Europe/Bucharest">Romania (EET/EEST)</option>
                    <option value="Russia|Europe/Moscow">Russia (MSK)</option>
                    <option value="Rwanda|Africa/Kigali">Rwanda (CAT)</option>
                    <option value="Saudi Arabia|Asia/Riyadh">Saudi Arabia (AST)</option>
                    <option value="Senegal|Africa/Dakar">Senegal (GMT)</option>
                    <option value="Serbia|Europe/Belgrade">Serbia (CET/CEST)</option>
                    <option value="Seychelles|Indian/Mahe">Seychelles (+04)</option>
                    <option value="Sierra Leone|Africa/Freetown">Sierra Leone (GMT)</option>
                    <option value="Singapore|Asia/Singapore">Singapore (SGT)</option>
                    <option value="Slovakia|Europe/Bratislava">Slovakia (CET/CEST)</option>
                    <option value="Slovenia|Europe/Ljubljana">Slovenia (CET/CEST)</option>
                    <option value="Somalia|Africa/Mogadishu">Somalia (EAT)</option>
                    <option value="South Africa|Africa/Johannesburg">South Africa (SAST)</option>
                    <option value="South Korea|Asia/Seoul">South Korea (KST)</option>
                    <option value="South Sudan|Africa/Juba">South Sudan (CAT)</option>
                    <option value="Spain|Europe/Madrid">Spain (CET/CEST)</option>
                    <option value="Sri Lanka|Asia/Colombo">Sri Lanka (+05:30)</option>
                    <option value="Sudan|Africa/Khartoum">Sudan (CAT)</option>
                    <option value="Suriname|America/Paramaribo">Suriname (-03)</option>
                    <option value="Sweden|Europe/Stockholm">Sweden (CET/CEST)</option>
                    <option value="Switzerland|Europe/Zurich">Switzerland (CET/CEST)</option>
                    <option value="Syria|Asia/Damascus">Syria (+03)</option>
                    <option value="Taiwan|Asia/Taipei">Taiwan (CST)</option>
                    <option value="Tajikistan|Asia/Dushanbe">Tajikistan (+05)</option>
                    <option value="Tanzania|Africa/Dar_es_Salaam">Tanzania (EAT)</option>
                    <option value="Thailand|Asia/Bangkok">Thailand (+07)</option>
                    <option value="Togo|Africa/Lome">Togo (GMT)</option>
                    <option value="Trinidad and Tobago|America/Port_of_Spain">Trinidad and Tobago (AST)</option>
                    <option value="Tunisia|Africa/Tunis">Tunisia (CET)</option>
                    <option value="Turkey|Europe/Istanbul">Turkey (TRT)</option>
                    <option value="Turkmenistan|Asia/Ashgabat">Turkmenistan (+05)</option>
                    <option value="Uganda|Africa/Kampala">Uganda (EAT)</option>
                    <option value="Ukraine|Europe/Kiev">Ukraine (EET/EEST)</option>
                    <option value="United Arab Emirates|Asia/Dubai">United Arab Emirates (+04)</option>
                    <option value="United Kingdom|Europe/London">United Kingdom (GMT/BST)</option>
                    <option value="United States|America/New_York">United States/New York (EST/EDT)</option>
                    <option value="United States|America/Chicago">United States/Chicago (CST/CDT)</option>
                    <option value="United States|America/Los_Angeles">United States/Los Angeles (PST/PDT)</option>
                    <option value="United States|America/Anchorage">United States/Anchorage (AKST/AKDT)</option>
                    <option value="United States|Pacific/Honolulu">United States/Honolulu (HST)</option>
                    <option value="Uruguay|America/Montevideo">Uruguay (-03)</option>
                    <option value="Uzbekistan|Asia/Tashkent">Uzbekistan (+05)</option>
                    <option value="Vanuatu|Pacific/Efate">Vanuatu (+11)</option>
                    <option value="Venezuela|America/Caracas">Venezuela (VET)</option>
                    <option value="Vietnam|Asia/Ho_Chi_Minh">Vietnam (+07)</option>
                    <option value="Yemen|Asia/Aden">Yemen (+03)</option>
                    <option value="Zambia|Africa/Lusaka">Zambia (CAT)</option>
                    <option value="Zimbabwe|Africa/Harare">Zimbabwe (CAT)</option>
                </select>
            </div>
        </div>
        <div class="card bg-gray-800 rounded-lg p-6 mb-6 shadow-lg fade-in">
            <h2 class="text-2xl font-semibold text-indigo-300 mb-4">Market Status</h2>
            <p id="market-status" class="text-3xl font-bold mb-2"></p>
            <p id="market-countdown" class="text-xl text-red-400 mb-4"></p>
            <p id="market-local" class="text-lg text-blue-300 italic mb-4"></p>
            <button id="toggle-details" class="text-indigo-400 hover:text-indigo-300 text-sm">Show More</button>
            <div id="details-content" class="collapsible-content text-sm text-gray-300 mt-4">
                <p id="premarket-info"></p>
                <p id="regular-open-info"></p>
                <p id="regular-close-info"></p>
                <p id="afterhours-info"></p>
                <p id="market-note" class="text-yellow-300"></p>
            </div>
        </div>
        <div class="text-center text-gray-400 text-sm space-y-2">
            <p>Current time in ET: <span id="et-time" class="font-medium">Detecting...</span></p>
            <p>Current time in local: <span id="local-time" class="font-medium">Detecting...</span></p>
        </div>
    </div>
    <script>
        const { DateTime } = luxon;

        const brokers = {
            standard: { premarketHour: 4, premarketMinute: 0, label: "Standard (4:00 AM ET)" },
            tastytrade: { premarketHour: 8, premarketMinute: 0, label: "tastytrade (8:00 AM ET)" },
            interactive_brokers: { premarketHour: 4, premarketMinute: 0, label: "Interactive Brokers (4:00 AM ET)" },
            webull: { premarketHour: 4, premarketMinute: 0, label: "Webull (4:00 AM ET)" },
            moomoo: { premarketHour: 4, premarketMinute: 0, label: "Moomoo (4:00 AM ET)" },
            tradestation: { premarketHour: 4, premarketMinute: 0, label: "TradeStation (4:00 AM ET)" },
            alpaca: { premarketHour: 4, premarketMinute: 0, label: "Alpaca Trading (4:00 AM ET)" },
            lightspeed: { premarketHour: 4, premarketMinute: 0, label: "Lightspeed (4:00 AM ET)" },
            tradezero: { premarketHour: 4, premarketMinute: 0, label: "TradeZero (4:00 AM ET)" }
        };

        const holidays = [
            '2025-01-01', '2025-01-20', '2025-02-17', '2025-04-18', '2025-05-26',
            '2025-06-19', '2025-07-04', '2025-09-01', '2025-11-27', '2025-12-25'
        ];

        const earlyCloses = ['2025-07-03', '2025-12-24'];

        let localZone = 'auto';
        let selectedCountry = 'auto';

        function getEffectiveLocalZone() {
            return localZone === 'auto' ? DateTime.now().zoneName : localZone;
        }

        function isWeekend(dt) {
            return dt.weekday > 5;
        }

        function isHoliday(dt) {
            return holidays.includes(dt.toISODate());
        }

        function isEarlyClose(dt) {
            return earlyCloses.includes(dt.toISODate());
        }

        function formatTimeDiff(target, isCountdown) {
            const now = DateTime.now();
            const diff = target.diff(now, ['days', 'hours', 'minutes', 'seconds']).toObject();
            if (isCountdown) {
                if (diff.days < 0 || (diff.days === 0 && diff.hours < 0) || (diff.days === 0 && diff.hours === 0 && diff.minutes < 0)) {
                    return { text: "Open", class: "status-open" };
                }
                return { text: `${Math.floor(diff.days)}d ${Math.floor(diff.hours)}h ${Math.floor(diff.minutes)}m ${Math.floor(diff.seconds)}s`, class: "text-red-400" };
            } else {
                if (diff.days > 0 || diff.hours > 0 || diff.minutes > 0 || diff.seconds > 0) {
                    return { text: `Closes in ${Math.floor(diff.days)}d ${Math.floor(diff.hours)}h ${Math.floor(diff.minutes)}m ${Math.floor(diff.seconds)}s`, class: "text-red-400" };
                }
                return { text: "Closed", class: "status-closed" };
            }
        }

        function getNextTarget(hour, minute, isClose = false) {
            const nowET = DateTime.now().setZone('America/New_York');
            let targetET = nowET.set({ hour, minute, second: 0, millisecond: 0 });

            if (isClose && isEarlyClose(targetET)) {
                targetET = targetET.set({ hour: 13, minute: 0 });
            }

            if (targetET <= nowET) {
                if (isClose) {
                    return { targetET, targetLocal: targetET.setZone(getEffectiveLocalZone()), note: "Closed", isOpen: false };
                }
                targetET = targetET.plus({ days: 1 }).set({ hour, minute, second: 0, millisecond: 0 });
            }

            while (isWeekend(targetET) || isHoliday(targetET)) {
                targetET = targetET.plus({ days: 1 }).set({ hour, minute, second: 0, millisecond: 0 });
                if (isClose && isEarlyClose(targetET)) {
                    targetET = targetET.set({ hour: 13, minute: 0 });
                }
            }

            const effectiveZone = getEffectiveLocalZone();
            const targetLocal = targetET.setZone(effectiveZone);
            const note = isClose && isEarlyClose(targetET) ? "Note: Early close at 1:00 PM ET." : "";
            return { targetET, targetLocal, note, isOpen: true };
        }

        function isMarketOpen() {
            const nowET = DateTime.now().setZone('America/New_York');
            const selectedBroker = document.getElementById('broker-select').value;
            const { premarketHour, premarketMinute } = brokers[selectedBroker];
            const premarketOpen = nowET.set({ hour: premarketHour, minute: premarketMinute, second: 0, millisecond: 0 });
            const regularOpen = nowET.set({ hour: 9, minute: 30, second: 0, millisecond: 0 });
            let regularClose = nowET.set({ hour: 16, minute: 0, second: 0, millisecond: 0 });
            let afterhoursClose = nowET.set({ hour: 20, minute: 0, second: 0, millisecond: 0 });

            if (isEarlyClose(nowET)) {
                regularClose = nowET.set({ hour: 13, minute: 0, second: 0, millisecond: 0 });
                afterhoursClose = nowET.set({ hour: 13, minute: 0, second: 0, millisecond: 0 });
            }

            return {
                isPremarket: !isWeekend(nowET) && !isHoliday(nowET) && nowET >= premarketOpen && nowET < regularOpen,
                isRegular: !isWeekend(nowET) && !isHoliday(nowET) && nowET >= regularOpen && nowET <= regularClose,
                isAfterhours: !isWeekend(nowET) && !isHoliday(nowET) && nowET > regularClose && nowET <= afterhoursClose
            };
        }

        function updateMarketTimers() {
            const marketStatus = document.getElementById('market-status');
            const marketCountdown = document.getElementById('market-countdown');
            const marketLocal = document.getElementById('market-local');
            const marketNote = document.getElementById('market-note');
            const premarketInfo = document.getElementById('premarket-info');
            const regularOpenInfo = document.getElementById('regular-open-info');
            const regularCloseInfo = document.getElementById('regular-close-info');
            const afterhoursInfo = document.getElementById('afterhours-info');
            const selectedBroker = document.getElementById('broker-select').value;
            const { premarketHour, premarketMinute, label } = brokers[selectedBroker];
            const { isPremarket, isRegular, isAfterhours } = isMarketOpen();

            const sessions = [
                { id: 'premarket', name: `Premarket (${label})`, hour: premarketHour, minute: premarketMinute, isClose: false },
                { id: 'regular-open', name: 'Regular Market Open (9:30 AM ET)', hour: 9, minute: 30, isClose: false },
                { id: 'regular-close', name: `Regular Market Close (${isEarlyClose(DateTime.now().setZone('America/New_York')) ? '1:00 PM ET' : '4:00 PM ET'})`, hour: 16, minute: 0, isClose: true },
                { id: 'afterhours', name: `After-Hours Close (${isEarlyClose(DateTime.now().setZone('America/New_York')) ? '1:00 PM ET' : '8:00 PM ET'})`, hour: 20, minute: 0, isClose: true }
            ];

            let note = '';

            if (isRegular) {
                const { targetET, targetLocal, note: closeNote } = getNextTarget(16, 0, true);
                const timeDiff = formatTimeDiff(targetET, false);
                marketStatus.textContent = 'Market is Open!';
                marketStatus.className = 'text-3xl font-bold status-open mb-2';
                marketCountdown.textContent = timeDiff.text;
                marketCountdown.className = `text-xl ${timeDiff.class} mb-4`;
                marketLocal.textContent = `Closes at ${targetLocal.toFormat('ff')}`;
                note = closeNote;
            } else if (isPremarket) {
                const { targetET, targetLocal, note: openNote } = getNextTarget(9, 30, false);
                const timeDiff = formatTimeDiff(targetET, true);
                marketStatus.textContent = 'Premarket is Open!';
                marketStatus.className = 'text-3xl font-bold status-open mb-2';
                marketCountdown.textContent = timeDiff.text;
                marketCountdown.className = `text-xl ${timeDiff.class} mb-4`;
                marketLocal.textContent = `Regular market opens at ${targetLocal.toFormat('ff')}`;
                note = openNote;
            } else if (isAfterhours) {
                const { targetET, targetLocal, note: closeNote } = getNextTarget(20, 0, true);
                const timeDiff = formatTimeDiff(targetET, false);
                marketStatus.textContent = 'After-Hours Trading';
                marketStatus.className = 'text-3xl font-bold status-open mb-2';
                marketCountdown.textContent = timeDiff.text;
                marketCountdown.className = `text-xl ${timeDiff.class} mb-4`;
                marketLocal.textContent = `Closes at ${targetLocal.toFormat('ff')}`;
                note = closeNote;
            } else {
                const { targetET, targetLocal, note: openNote } = getNextTarget(9, 30, false);
                const timeDiff = formatTimeDiff(targetET, true);
                marketStatus.textContent = 'Market is Closed';
                marketStatus.className = 'text-3xl font-bold status-closed mb-2';
                marketCountdown.textContent = timeDiff.text;
                marketCountdown.className = `text-xl ${timeDiff.class} mb-4`;
                marketLocal.textContent = `Next open at ${targetLocal.toFormat('ff')}`;
                note = openNote;
            }

            sessions.forEach(session => {
                const { targetET, targetLocal, note: sessionNote, isOpen } = getNextTarget(session.hour, session.minute, session.isClose);
                const timeDiff = formatTimeDiff(targetET, !session.isClose);
                document.getElementById(`${session.id}-info`).textContent = `${session.name}: ${timeDiff.text} (ET: ${targetET.toFormat('ff')}, Local: ${targetLocal.toFormat('ff')})`;
                if (sessionNote) note = sessionNote;
            });

            marketNote.textContent = note || 'No special notes for today.';
        }

        async function updateCountdowns() {
            await new Promise(resolve => setTimeout(resolve, 1000));
            await updateMarketTimers();
            document.getElementById('et-time').textContent = DateTime.now().setZone('America/New_York').toFormat('ff');
            document.getElementById('local-time').textContent = DateTime.now().setZone(getEffectiveLocalZone()).toFormat('ff');
        }

        function updateBroker() {
            updateCountdowns();
        }

        function updateCountry() {
            const countrySelect = document.getElementById('country-select');
            const [country, timezone] = countrySelect.value.split('|');
            selectedCountry = country;
            localZone = timezone;
            updateCountdowns();
        }

        document.addEventListener('DOMContentLoaded', () => {
            updateCountry();
            updateCountdowns();
            setInterval(updateCountdowns, 1000);

            const toggleButton = document.getElementById('toggle-details');
            const detailsContent = document.getElementById('details-content');
            toggleButton.addEventListener('click', () => {
                detailsContent.classList.toggle('active');
                toggleButton.textContent = detailsContent.classList.contains('active') ? 'Hide Details' : 'Show More';
            });
        });
    </script>
</body>
</html>
